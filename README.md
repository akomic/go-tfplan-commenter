# Terraform Plan Commenter

A Go CLI tool that parses Terraform plan JSON files and generates Markdown comments for GitHub Actions PR reviews.

## Installation

### Quick Install (Recommended)

```bash
curl -sSL https://raw.githubusercontent.com/akomic/go-tfplan-commenter/main/install.sh | bash
```

### Download Pre-built Binaries

Download the latest release from the [releases page](https://github.com/akomic/go-tfplan-commenter/releases):

- **Linux (x86_64)**: `tfplan-commenter-linux-amd64`
- **macOS (Intel)**: `tfplan-commenter-darwin-amd64`
- **macOS (Apple Silicon)**: `tfplan-commenter-darwin-arm64`

```bash
# Download and install (example for Linux)
curl -L -o tfplan-commenter https://github.com/akomic/go-tfplan-commenter/releases/latest/download/tfplan-commenter-linux-amd64
chmod +x tfplan-commenter
sudo mv tfplan-commenter /usr/local/bin/
```

### Build from Source

```bash
git clone https://github.com/akomic/go-tfplan-commenter.git
cd go-tfplan-commenter
make build
```

## Features

- Parses Terraform plan JSON files generated from `terraform show -json plan.tfplan`
- Categorizes resources by action type (Create, Update, Delete, Replace)
- **Shows detailed attribute changes for updated resources**
- **Displays reasons for resource replacement/deletion**
- **Highlights specific attributes that force replacement**
- Generates formatted Markdown suitable for GitHub PR comments
- Provides summary statistics and detailed resource lists
- Handles large resource lists with truncation for readability

## Usage

### Basic Usage

```bash
# Show version
tfplan-commenter -version

# Show help
tfplan-commenter -help

# Generate comment from plan.json
tfplan-commenter plan.json

# Specify custom output file
tfplan-commenter plan.json my-comment.md
```

### Using Makefile

```bash
# Build the program
make build

# Build for all platforms
make build-all

# Create release with all binaries
make release

# Run with default settings
make run

# Run with custom output
make run-output

# Test the program
make test

# Show version
make version

# Clean build artifacts
make clean
```

### GitHub Actions Integration

Here's an example of how to use this in a GitHub Actions workflow:

```yaml
name: Terraform Plan Comment

on:
  pull_request:
    paths:
      - '**.tf'
      - '**.tfvars'

jobs:
  terraform-plan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.8

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        run: |
          terraform plan -out=plan.tfplan
          terraform show -json plan.tfplan > plan.json

      - name: Download Plan Commenter
        run: |
          curl -L -o tfplan-commenter https://github.com/akomic/go-tfplan-commenter/releases/latest/download/tfplan-commenter-linux-amd64
          chmod +x tfplan-commenter

      - name: Generate Plan Comment
        run: ./tfplan-commenter plan.json terraform-plan-comment.md

      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('terraform-plan-comment.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
```

## Input Format

The program expects a JSON file generated by:

```bash
terraform plan -out=plan.tfplan
terraform show -json plan.tfplan > plan.json
```

## Output Format

The program generates a Markdown file with:

- Summary statistics of affected resources
- Categorized resource lists (Create, Update, Delete, Replace)
- Emoji indicators for different action types
- Truncated lists for large numbers of resources

### Example Output

```markdown
## ðŸ“‹ Terraform Plan Summary

**Total resources affected:** 3

| Action | Count | Resources |
|--------|-------|-----------|
| ðŸŸ¢ **Create** | 1 | aws_s3_bucket.example |
| ðŸŸ¡ **Update** | 1 | aws_instance.web |
| ðŸ”´ **Delete** | 1 | aws_security_group.old |

### ðŸŸ¢ Resources to be Created

- `aws_s3_bucket.example`

### ðŸŸ¡ Resources to be Updated

#### `aws_instance.web`

**Attributes being modified:**

- **instance_type**: "t2.micro" â†’ "t3.micro"
- **tags**: {"Environment": "dev"} â†’ {"Environment": "dev", "Updated": "true"}

### ðŸ”´ Resources to be Deleted

#### `aws_security_group.old`

**Resource details:** Resource with name: old-security-group, id: sg-12345678

---
*Generated from Terraform 1.9.8 plan*
```

## Requirements

- Go 1.21 or later
- Terraform plan JSON file

## License

MIT License
